-- This file is used to generate build.ninja to out directory.
-------------------------------------------------------------------------------

function string.endswith(s, sub_str)
    local s = string.sub(s, -#sub_str)
    return s == sub_str
end

-------------------------------------------------------------------------------
-- class 

local _class = {}

local function class(name)
    local clazz = {__cname = name}
    _class[name] = clazz
    clazz.new = function(...)
        local instance = {}
        setmetatable(instance, {__index = clazz})
        if clazz.ctor then
            clazz.ctor(instance, ...)
        end
        return instance
    end
    return clazz
end

-------------------------------------------------------------------------------
-- ninja syntax writer

local writer = class("writer")

function writer:ctor(output)
    self.output = output
end

function writer:comment(c)
    self.output:write("#  " .. c .. "\n")
end

function writer:newline() 
    self.output:write("\n")
end

function writer:variable(key, value, indent)
    self:_line(string.format("%s = %s", key, value), indent)
end

function writer:rule(name, command, description)
    self:_line("rule " .. name)
    self:variable("command", command, 1)
    if description ~= nil then
        self:variable("description", description, 1)
    end
end

function writer:build(output, rule, input)
    self:_line(string.format("build %s: %s %s", output, rule, input))
end

function writer:default(...)
    self:_line(string.format('default %s', table.concat({...}, " ")))
end

function writer:_line(text, indent)
    if indent == nil then
        indent = 0
    end
    local leading_space = string.rep("  ", indent)
    self.output:write(leading_space .. text .. '\n')
end

function writer:close()
    self.output:close()
end


-------------------------------------------------------------------------------
-- declare

local function declare()
    local rules = {}
    table.insert(rules, {
        name = "cc",
        command = "gcc ${defines} ${include_dirs} ${cflags} -c ${in} -o ${out}",
        description = "CC ${out}"
    })
    table.insert(rules, {
        name = "link",
        command = "gcc ${libs_dirs} ${libs} -o ${out} ${in}",
        description = "LINK ${out}"
    })
    table.insert(rules, {
        name = "rc",
        command = "windres -i ${in} -o ${out}",
        description = "RC ${out}"
    })

    local target = {}
    target.name = "llab"

    target.sources = {
        "src/llab.rc",
        "src/llab.c",
        "src/ll_driver.c",
        "src/ll_engine.c",
        "src/ll_client.c"
    }
    return rules, target
end

-------------------------------------------------------------------------------
-- gen build.ninja
local function gen(rules, target, writer)
    local w = writer
    -- head
    w:comment("This file is used to build llab.")
    w:comment("It is generated by configure.lua.")
    w:newline()
    w:variable("ninja_required_version", "1.10")
    w:newline()

    -- rules
    for _, rule in ipairs(rules) do
        w:rule(rule.name, rule.command, rule.description)
    end
    w:newline()

    -- attributes
    w:variable("cflags", "-g -O2 -Wall")
    w:variable('defines', "-DUNICODE")
    w:variable('include_dirs', "")
    w:newline()

    -- target
    local deps = {}
    for _, source in ipairs(target.sources) do
        local outname = ""
        if string.endswith(source, '.c') then
            outname = string.sub(source, 1, -3) .. ".o"
            table.insert(deps, outname)
            w:build(outname, "cc", "../" .. source)
        elseif string.endswith(source, '.rc') then
            outname = source .. ".o"
            table.insert(deps, outname)
            w:build(outname, "rc", "../" .. source)
        end
    end

    w:newline()

    local tn = target.name .. ".exe"
    w:build(tn, "link", table.concat(deps, " "))

    -- default
    w:newline()
    w:default(tn)
end

local function main()
    local r, t = declare()
    local f = io.open("./out/build.ninja", "w")
    local w = writer.new(f)
    gen(r, t, w)
    w:close()
end

main()